# Year Planner Generator — Architecture

## Overview

The Year Planner Generator is a Python application that produces a configurable Microsoft Word document from a YAML configuration file.

```txt
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ config/         │     │  src/           │     │  output/        │
│ config.yaml     │────>│  Python         │────>│  YearPlanner    │
│ (Parameters)    │     │  Generator      │     │  .docx          │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

---

## Technology Stack

| Component | Technology | Purpose |
|-----------|------------|---------|
| Language | Python 3.x | Generator implementation |
| Document Library | `python-docx` | Word document creation/manipulation |
| PDF Conversion | `docx2pdf` | Word to PDF conversion (requires MS Word) |
| Configuration | YAML | Human-readable parameter file |
| Output | Microsoft Word (.docx), PDF (.pdf) | Final printable documents |

---

## Project Structure

```txt
year_planner/
├── CLAUDE.md                   # Claude Code guidance
├── .markdownlint.json          # Markdown linting configuration
├── requirements.txt            # Python dependencies
├── run.bat                     # Windows batch file to run generator
├── activate.bat                # Windows batch file to activate venv
│
├── .claude/
│   ├── commands/
│   │   └── save-checkpoint.md  # Custom slash command for checkpoints
│   └── prompts/
│       └── prompt-temp.md      # Reusable prompts
│
├── .vscode/
│   └── settings.json           # VS Code workspace settings
│
├── assets/
│   └── images/                 # Generated images (graph paper grids)
│
├── backup/                     # Versioned backups (.zip files)
│
├── config/
│   └── config.yaml             # Generator configuration
│
├── docs/
│   ├── SPEC.md                 # Product specification
│   └── ARCHITECTURE.md         # System design (this file)
│
├── output/                     # Generated Year Planner documents
│
├── scripts/
│   └── check_deps.py           # Dependency checker (imports vs requirements.txt)
│
├── src/                        # Python source code
│   ├── main.py                 # Entry point with prettified output, PDF conversion
│   ├── config.py               # YAML loading and validation
│   ├── document.py             # Document initialization, debug visualization
│   ├── sections/
│   │   ├── backlog.py          # Backlog tables for unscheduled tasks
│   │   ├── calendar.py         # Year calendar grids (current + next year)
│   │   ├── cover.py            # Front and inside cover
│   │   ├── goals.py            # Goals page with configurable table
│   │   ├── graph_paper.py      # Graph paper pages with grid images
│   │   ├── instructions.py     # Instructions page
│   │   ├── monthly.py          # Month covers and daily spread tables (×12)
│   │   ├── rear_cover.py       # Rear cover (blank, reserved)
│   │   ├── terms_definitions.py # Terms and definitions tables
│   │   ├── toc.py              # Table of Contents with pre-calculated page numbers
│   │   └── week_planner.py     # Week planner tables (ISO 8601)
│   └── utils/
│       ├── grid_image.py       # Graph paper grid image generation (PIL)
│       ├── styles.py           # Font and paragraph styles
│       └── tables.py           # Table creation helpers
│
└── test/
    └── print_store_samples/    # Sample outputs for testing
```

---

## Generator Pipeline

```
1. Load Configuration (config/config.yaml)
        │
        ▼
2. Initialize Document
   (page size, margins, gutters)
        │
        ▼
3. Generate Sections (in order)
   ├── Cover Page
   ├── Instructions
   ├── Calendars
   ├── Table of Contents
   ├── Goals
   ├── Backlog
   ├── Week Planner
   ├── Monthly Sections (×12)
   │   ├── Month Cover
   │   └── Daily Spread
   ├── Terms and Definitions
   ├── Graph Paper
   └── Rear Cover
        │
        ▼
4. Apply Page Numbering
   (logical numbering, footer positioning)
        │
        ▼
5. Save Document (output/)
        │
        ▼
6. Convert to PDF (output/)
```

---

## Key Design Decisions

### 1. Configuration-Driven Generation

All variable aspects of the document are controlled via `config/config.yaml`. The generator code should not contain hardcoded values for parameters like row counts, margins, or colors.

### 2. Section-Based Architecture

Each document section is generated by a dedicated module in `src/sections/`. This allows:

- Independent testing of sections
- Easy addition/removal of sections
- Clear separation of concerns

### 3. Logical vs. Physical Page Tracking

The generator must maintain two separate page counters:

- **Physical page count:** For duplex layout (recto/verso positioning)
- **Logical page count:** For TOC references and footer numbering

### 4. Table-Centric Layout

Content is structured using Word tables rather than free-form paragraphs. This enables:

- Precise dimensional control
- Predictable page filling
- Consistent alignment across pages

---

## Table Implementation

### Standard Table Structure

All tables follow a three-row-type structure defined in `src/sections/week_planner.py`:

```python
# Row heights in twips (defined as constants)
TITLE_ROW_HEIGHT_TWIPS = 284   # 14.2 pt
HEADER_ROW_HEIGHT_TWIPS = 284  # 14.2 pt

# Column widths in dxa (twips) - for A4 (18.8 cm content area)
WEEK_COL_WIDTH_DXA = 785       # ~1.38 cm
MONTH_COL_WIDTH_DXA = 2222     # ~3.92 cm
```

### Key Helper Functions (`src/document.py`)

| Function | Purpose |
|----------|---------|
| `compute_table_row_height()` | Calculates content row height to fill page |
| `validate_table_height()` | Computes row height and warns if table won't fit |
| `add_page_break(minimize_height=True)` | Adds page break with minimal vertical space |
| `add_section_break()` | Adds section break without page numbering |
| `add_numbered_section_break()` | Adds section break with page numbering enabled |
| `add_non_numbered_section_break()` | Adds section break that clears footers (for rear cover) |
| `get_content_height_twips()` | Returns available vertical space in twips |
| `get_content_width_twips()` | Returns available horizontal space in twips |

### Constants (`src/document.py`)

```python
EMPTY_PARAGRAPH_HEIGHT_TWIPS = 240    # Normal paragraph (~12pt)
MINIMIZED_PARAGRAPH_HEIGHT_TWIPS = 20 # Minimized paragraph (1pt)
SAFETY_MARGIN_TWIPS = 40              # Buffer to prevent overflow (2pt)
```

### Row Height Calculation Formula

For tables that fill the page vertically:

$$r_c = \frac{p_v - p_{para} - s - r_t - r_h}{n}$$

Where:

| Symbol | Description | Source |
|--------|-------------|--------|
| $r_c$ | Content row height | Computed result |
| $p_v$ | Page vertical content area | `get_content_height_twips()` |
| $p_{para}$ | Preceding paragraph height | `MINIMIZED_PARAGRAPH_HEIGHT_TWIPS` |
| $s$ | Safety margin | `SAFETY_MARGIN_TWIPS` |
| $r_t$ | Title row height | `TITLE_ROW_HEIGHT_TWIPS` |
| $r_h$ | Header row height | `HEADER_ROW_HEIGHT_TWIPS` |
| $n$ | Number of content rows | Configuration parameter |

### Table Cell Styling Functions (`src/sections/week_planner.py`)

| Function | Purpose |
|----------|---------|
| `_set_table_layout_fixed()` | Prevents auto-column-resizing |
| `_set_table_grid()` | Sets explicit column widths in dxa |
| `_set_row_height(exact=True)` | Sets row height with `hRule="exact"` |
| `_set_cell_width()` | Sets cell width in dxa |
| `_set_cell_shading()` | Sets background color (hex) |
| `_set_cell_vertical_alignment()` | Sets vertical alignment ("center") |
| `_add_cell_text()` | Adds formatted text to cell |
| `_set_table_borders()` | Applies standard border styling |

### Minimized Page Breaks

When tables must fill the page precisely, use minimized page breaks:

```python
add_page_break(document, minimize_height=True)
```

This creates a paragraph with:
- Font size: 1pt
- Line spacing: Exactly 1pt
- Space before/after: 0pt

Total height: 20 twips (1pt), leaving maximum space for the table.

---

## Critical Implementation Notes

### Page Breaks

| Scenario | Action |
|----------|--------|
| Content fills page (Day Tables, Graph Paper) | **No** explicit page break needed |
| Content does NOT fill page | **Add** page break before next content |
| Between separate tables needing own pages | **Add** page break |

### Footer Configuration

- Use Word document sections for different footer configurations.
- Front matter (Cover, Instructions, Calendar, TOC) has no page numbers.
- Numbered sections (Goals, Backlog, Week Planner, Monthly, Terms and Definitions, Graph Paper) use `add_numbered_section_break()`.
- Different odd/even footers enabled via `_enable_different_odd_even_headers()`.
- Recto (odd) pages: page number bottom-right, right-aligned.
- Verso (even) pages: page number bottom-left, left-aligned.
- Page number inserted using Word's PAGE field for automatic updating.
- Use `footer` property in page margins for "Footer from bottom" distance.
- **Do NOT** use `spacing.before` on footer paragraphs (pushes content up).

### Duplex Layout

- Recto (odd) pages appear on the right.
- Verso (even) pages appear on the left.
- Gutter is on the binding side (right for verso, left for recto).

---

## Data Flow: TOC Generation

The TOC requires foreknowledge of page numbers. The generator must:

1. Pre-calculate logical page assignments for all content.
2. Generate TOC entries with correct page references.
3. Generate actual content sections.
4. Verify page counts match predictions.

```txt
┌─────────────────────────────────────────────────────────┐
│                  Page Number Calculation                │
├─────────────────────────────────────────────────────────┤
│  1. Count pages per section based on config             │
│  2. Assign logical page numbers to each element         │
│  3. Build TOC entry list with (label, page_number)      │
│  4. Generate TOC tables                                 │
│  5. Generate content sections                           │
│  6. Assert final page count matches calculation         │
└─────────────────────────────────────────────────────────┘
```

---

## Testing Strategy

| Test Type | Scope | Location |
|-----------|-------|----------|
| Unit | Individual section generators | `test/` |
| Integration | Full document generation with sample config | `test/` |
| Visual | Manual inspection of printed output | `test/print_store_samples/` |
| Regression | Compare generated documents across versions | `test/` |

---

## Image Generation

Generated images are stored in `assets/images/` with configuration-based filenames for caching:

```
assets/images/
└── graph_paper_{cols}x{rows}_{grid%}_{border%}_{width}x{height}px.png
```

The filename includes pixel dimensions so images automatically regenerate when page layout (margins, page size) changes.

**Pipeline:**
1. Check if image exists in `assets/images/` (matching current dimensions)
2. If missing, generate using Pillow at 300 DPI
3. Insert into document via `document.add_picture()`
4. Subsequent runs reuse cached image if dimensions match

---

## Future Considerations

- **Branding:** Rear cover barcode and branding for commercial distribution.
- **Localization:** Month/day names in different languages.
